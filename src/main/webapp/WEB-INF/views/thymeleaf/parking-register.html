<div th:replace="fragments/header.html"></div>

<main role="main" class="container-fluid m-f">

    <section>

        <article class="container text-white bg-windows mx-auto col-lg-8 p-2 my-3 rounded-4">

            <h1 class="titleView fs-3">Registrar Parking</h1>

            <form th:action="@{/mobile/parking/register}" action="#" method="post" th:object="${parkingRegister}" onsubmit="return validateForm()">


                <div class="divContainer divContainerBorderBottom my-1">

                    <label for="parkingType" class="text-white text-bold mb-1">Seleccionar Tipo:</label>

                    <select th:field="*{parkingType}" id="parkingType" onchange="renderForms()" class="form-select my-1">

                        <option value="STREET" selected>Vía Publica</option>

                        <option value="GARAGE">Estacionamiento</option>

                        <option value="POINT_SALE">Estacionamiento Medido</option>

                    </select>

                </div>

                <div class="divContainer divContainerBorderBottom my-1">

                    <label for="vehicle" class="text-white text-bold mb-1">Seleccionar Vehículo:</label>

                    <select th:field="*{vehicle}" id="vehicle" th:each="vehicle : ${vehicleList}" class="form-select my-1">

                        <option th:value="${vehicle.patent}" th:text="${vehicle.brand + ' - ' + vehicle.patent}">

                            Marca - Patente

                        </option>

                    </select>

                </div>

                <div class="divContainer divContainerBorderBottom my-1">

                    <label for="vehiclePic" class="text-white text-bold mb-1">Foto del vehículo:</label>

                    <input th:field="*{vehiclePic}" id="vehiclePic"  type="file" accept="image/jpeg" class="form-control my-1">

                </div>

                <div id="typeGarage" class="divContainer divContainerBorderBottom my-1" style="display:none">

                    <label for="ticketPic" class="text-white text-bold mb-1">Foto de Ticket:</label>

                    <input th:field="*{ticketPic}" id="ticketPic"  type="file" accept="image/jpeg" class="form-control my-1">

                </div>

                <div class="divContainer divContainerBorderBottom my-1">

                    <label for="parkingDate" class="text-white text-bold mb-1">Fecha y hora de estacionamiento:</label>

                    <input th:field="*{parkingDate}" id="parkingDate" type="datetime-local" class="form-control my-1">
                </div>

                <div class="divContainer divContainerBorderBottom my-1">

                    <div>

                        <label for="enableAlarm" class="text-white text-bold mb-1">Agregar alarma:</label>

                        <input th:field="*{enableAlarm}" id="enableAlarm" type="checkbox" onchange="renderAlarmDate()">

                    </div>

                    <div>

                        <label for="alarmDate" class="text-white text-bold mb-1">Seleccione fecha y hora:</label>

                        <input th:field="*{alarmDate}" id="alarmDate" type="datetime-local" class="form-control my-1" disabled="disabled">

                    </div>

                </div>

                <div id="geolocation" class="divContainer divContainerBorderBottom my-1">

                    <label for="geolocation" class="text-white text-bold mb-1">Verifica el parking:</label>

                    <input th:field="*{lat}" id="lat" class="d-none" type="text">

                    <input th:field="*{ln}" id="ln" class="d-none" type="text">

                    <div>

                        <div id="myMap" class="mapRegister"></div>

                        <div id='infoBox'>
                            <div id='infoboxText'>
                                <b id='infoboxTitle'></b>
                                <a id='infoboxDescription'></a>
                            </div>
                        </div>

                    </div>

                </div>

                <div id="pointSaleDiv" class="divContainer my-1" style="display:none">

                    <label for="pointSale" class="text-white text-bold mb-1">Tu punto de pago seleccionado:</label>

                    <input th:field="*{parkingPlaceId}" id="pointSale" class="d-none" type="text">

                    <p id="pointSaleText" th:text="'Aún no se ha seleccionado un punto de pago.'" class="text-white"></p>


                    <!--Checkbox-->
                    <ul class="list-group text-shadow-none">
                        <li class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="listGroupRadio" value="" id="firstRadio" checked>
                            <label class="form-check-label" for="firstRadio">Efectivo</label>
                        </li>
                        <li class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="listGroupRadio" value="" id="secondRadio">
                            <label class="form-check-label" for="secondRadio">Tarjeta de crédito/débito</label>
                        </li>
                    </ul>

                    <!-- Modal -->
                    <div class="modal text-shadow-none" id="myModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" style="color: black;">Tarjeta de crédito/débito</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-black" >
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control rounded-3" id="floatingInput" placeholder="Nombre completo" form="dummyForm">
                                        <label for="floatingInput">Nombre completo</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input type="number" class="form-control rounded-3" id="floatingNumber" placeholder="Numero de la tarjeta" form="dummyForm">
                                        <label for="floatingNumber">Numero de la tarjeta</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control rounded-3" id="expiration" placeholder="Fecha de vencimiento" maxlength="5" oninput="formatExpiration()" form="dummyForm">
                                        <label for="expiration">Fecha de vencimiento</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input type="number" class="form-control rounded-3" id="floatingCod" maxlength="4" placeholder="Código de seguridad" form="dummyForm">
                                        <label for="floatingCod">Codigo de seguridad</label>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="">Aceptar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <label for="amountHs" class="text-white text-bold mb-1">Selecciona la cantidad de horas:</label>

                    <input th:field="*{ammountHs}" id="amountHs" class="form-control my-1" type="number" value="0">

                </div>

                <div class="divContainer my-3">

                    <input type="submit" value="Registrar" class="btn btn-lg btn-block rounded-4 box-shadow text-bold px-5
             fs-6 text-center btn-primary text-white text-bold">

                </div>

                <div>

                    <p th:if="${error != null}"  th:text="'Error ' + ${error}"></p>

                </div>

            </form>
            <form id="dummyForm" style="display: none;"></form>
        </article>


    </section>

    <script th:inline="javascript">
        var parkingDateInput = document.getElementById("parkingDate");

        var now = new Date();
        var formattedNow = now.toISOString().slice(0, 16);

        parkingDateInput.value = formattedNow;

        function renderForms() {
            let parking = document.getElementById("parkingType").value;
            let divGarage = document.getElementById("typeGarage");
            let divPointSale = document.getElementById("pointSaleDiv");

            switch (parking) {
                case "GARAGE":
                    divGarage.style.display = "block";
                    divPointSale.style.display = "none";
                    break;
                case "POINT_SALE":
                    divPointSale.style.display = "block";
                    divGarage.style.display = "none";
                    break;
                case "STREET":
                    divPointSale.style.display = "none";
                    divGarage.style.display = "none";
                    break;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const modal = new bootstrap.Modal(document.getElementById("myModal"));
            const firstRadio = document.getElementById("firstRadio");
            const secondRadio = document.getElementById("secondRadio");

            // Abre el modal al hacer clic en el botón
            secondRadio.addEventListener("change", function () {
                if (secondRadio.checked) {
                    modal.show();
                } else {
                    modal.hide();
                }
            });

            // Cierra el modal al hacer clic en el botón "Aceptar" en el modal
            const acceptButton = document.querySelector("[data-bs-dismiss='modal'][data-bs-save-changes]");
            acceptButton.addEventListener("click", () => {
                modal.hide();
                firstRadio.disabled = false;
            });

            // Cierra el modal si se hace clic fuera del modal
            modal._element.addEventListener("hidden.bs.modal", () => {
                firstRadio.disabled = false;
            });
        });

        <!--input expiration-->
        function formatExpiration() {
            const input = document.getElementById("expiration");
            const value = input.value;

            const numericValue = value.replace(/\D/g, "");

            const month = numericValue.slice(0, 2);
            const year = numericValue.slice(2, 4);

            if (parseInt(month) < 1 || parseInt(month) > 12) {
                input.setCustomValidity("El mes debe estar entre 01 y 12");
            } else {
                input.setCustomValidity("");
            }

            if (numericValue.length >= 2) {
                input.value = `${month}/${year}`;
            } else {
                input.value = numericValue;
            }
        }

        function validateForm() {
            var parkingType = document.getElementById("parkingType").value;
            var pointSale = document.getElementById("pointSale").value;

            if (parkingType === "POINT_SALE" && pointSale === "") {
                alert("Por favor, selecciona un punto de pago antes de registrar el estacionamiento medido.");
                return false;
            }
            return true;
        }

    </script>

    <script th:inline="javascript">
        function renderAlarmDate() {
            let checkbox = document.getElementById("enableAlarm").checked;
            let date = document.getElementById("alarmDate");

            if(checkbox) {
                date.removeAttribute("disabled");
            } else {
                date.setAttribute("disabled", "disabled")
            }
        }
    </script>

    <script type='text/javascript'
            src='https://www.bing.com/api/maps/mapcontrol?callback=initializeBingMap&key=AmmJKyxVf-6eaa2iHK_GT4J0wH58FQbLciGKGgSMYZWJSjeZ8x5Tc67SrzWnTLmQ&setLang=es'
            async defer></script>

    <script th:inline="javascript">

        var credentials = "AmmJKyxVf-6eaa2iHK_GT4J0wH58FQbLciGKGgSMYZWJSjeZ8x5Tc67SrzWnTLmQ";
        var bingMap = null;
        var selectedPin = null;
        const pinPointSale = [];

        function initializeBingMap() {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        GetMap(position);
                    },
                    function (error) {
                        alert(error);
                        GetMap(null);
                    },
                    options
                );
            } else {
                GetMap(null);
            }
        }

        function GetMap(position) {
            var lat = null;
            var long = null;

            if (position != null) {
                lat = position.coords.latitude;
                long = position.coords.longitude;
            } else {
                lat = -34.670560;
                long = -58.562780;
            }
            document.getElementById("lat").value = lat;
            document.getElementById("ln").value = long;

            bingMap = new Microsoft.Maps.Map("#myMap", {
                credentials: credentials,
                center: new Microsoft.Maps.Location(lat, long),
                mapTypeId: Microsoft.Maps.MapTypeId.road,
                zoom: 18
            });

            var center = bingMap.getCenter();

            const url = `https://dev.virtualearth.net/REST/v1/Locations/${lat},${long}?key=${credentials}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.resourceSets.length > 0 && data.resourceSets[0].resources.length > 0) {
                        var address = data.resourceSets[0].resources[0].address.formattedAddress;
                        var personalPin = createPin(center, 'red', '¡Estoy aquí!', address);

                        Microsoft.Maps.Events.addHandler(personalPin, 'click', function (e) {
                            setInfoboxOnPin(personalPin);
                            personalPin.infobox.setOptions({visible: true})
                        });

                        adjustPersonalPinMap(personalPin);

                        bingMap.entities.push(personalPin);

                        createPinParkingPlaces();
                    } else {
                        console.error('No se encontró ninguna dirección.');
                    }
                })
                .catch(error => {
                    console.error('Error en la solicitud: ', error);
                });
        }

        function adjustPersonalPinMap(personalPin) {
            Microsoft.Maps.Events.addHandler(bingMap, 'click', function (e) {
                var newCenter = e.location;
                var newLat = newCenter.latitude;
                var newLng = newCenter.longitude;

                personalPin.setLocation(newCenter);

                document.getElementById("lat").value = newLat;
                document.getElementById("ln").value = newLng;

                const newUrl = `https://dev.virtualearth.net/REST/v1/Locations/${newLat},${newLng}?key=${credentials}`;

                fetch(newUrl)
                    .then(response => response.json())
                    .then(newData => {
                        if (newData.resourceSets.length > 0 && newData.resourceSets[0].resources.length > 0) {
                            personalPin.metadata.description = newData.resourceSets[0].resources[0].address.formattedAddress;
                        } else {
                            console.error('No se encontró ninguna dirección.');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la solicitud: ', error);
                    });
                setInfoboxOnPin(personalPin);
            });
        }

        function createPinParkingPlaces() {
            var parkingPlaces = [[${parkingPlaces}]];
            var promises = [];

            for (let i = 0; i < parkingPlaces.length; i++) {
                const lat = parkingPlaces[i].geolocation.lat;
                const ln = parkingPlaces[i].geolocation.ln;
                const title = parkingPlaces[i].name;
                const url = `https://dev.virtualearth.net/REST/v1/Locations/${lat},${ln}?key=${credentials}`;

                promises.push(
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.resourceSets.length > 0 && data.resourceSets[0].resources.length > 0) {
                                const address = data.resourceSets[0].resources[0].address.formattedAddress;

                                const pin = createPin(new Microsoft.Maps.Location(lat, ln), 'blue', title, address);

                                setInfoboxOnPin(pin);

                                Microsoft.Maps.Events.addHandler(pin, 'click', function () {
                                    for (var j = 0; j < pinPointSale.length; j++) {
                                        pinPointSale[j].infobox.setOptions({ visible: false });
                                    }

                                    pin.infobox.setOptions({ visible: true });

                                    if (selectedPin) {
                                        selectedPin.setOptions({ color: 'blue' });
                                    }

                                    selectedPin = pin;

                                    pin.setOptions({ color: 'green' });
                                    document.getElementById("pointSale").value = [[${parkingPlaces}]][i].id;
                                    document.getElementById("pointSaleText").textContent = parkingPlaces[i].name + " | " + address;
                                });

                                pinPointSale.push(pin);
                            } else {
                                console.error('No se encontró ninguna dirección.');
                            }
                        })
                        .catch(error => {
                            console.error('Error en la solicitud: ', error);
                        })
                );
            }

            Promise.all(promises)
                .then(() => {
                    bingMap.entities.push(pinPointSale);
                })
                .catch(error => {
                    console.error('Error al cargar los datos: ', error);
                });
        }

        function createPin(location, color, title, description) {
            var pin = new Microsoft.Maps.Pushpin(location, {
                color: color,
                title: title,
            });
            pin.metadata = {description: description};
            return pin;
        }

        function setInfoboxOnPin(pin) {
            var infobox = pin.infobox;

            if (!infobox) {
                var center = pin.getLocation();
                var title = pin.getTitle();
                var description = pin.metadata.description;

                infobox = new Microsoft.Maps.Infobox(center, {
                    title: title,
                    description: description,
                });

                infobox.setMap(bingMap);
                infobox.setOptions({
                    visible: false
                })
                pin.infobox = infobox;
            } else {
                var newCenter = pin.getLocation();
                var newTitle = pin.getTitle();
                var newDescription = pin.metadata.description;

                infobox.setLocation(newCenter);
                infobox.setOptions({
                    title: newTitle,
                    description: newDescription,
                    visible: false
                });
            }
        }

    </script>

</main>

<div th:replace="fragments/footer.html"></div>